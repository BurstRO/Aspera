package at

import (
	"encoding/hex"
	"testing"

	"github.com/stretchr/testify/assert"
)

type atTest struct {
	code string
	data string
	err  error
}

var atTests = []atTest{
	atTest{
		code: "01000000000000000000000000010100000001000000000000000102000000020000000000000001030000000300000000000000010400000004000000000000000105000000050000000000000001060000000600000000000000010700000007000000000000000108000000080000000000000001090000000900000000000000010a0000000a00000000000000010b0000000b00000000000000010c0000000c00000000000000010d0000000d00000000000000010e0000000e00000000000000010f0000000f0000000000000006000000000100000006010000000200000006020000000300000006030000000400000006040000000500000006050000000600000006060000000700000006070000000800000006080000000900000006090000000a000000060a0000000b000000060b0000000c000000060c0000000d000000060d0000000e000000060e0000000f00000028",
		data: "010000000000000003000000000000000500000000000000070000000000000009000000000000000b000000000000000d000000000000000f00000000000000110000000000000013000000000000001500000000000000170000000000000019000000000000001b000000000000001d000000000000000f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
	},
	atTest{
		code: "0101000000f0ffffffffffffff01040000000f000000000000000107000000ffffffffffffffff010a000000ffffffffffffffff010d000000f0ffffffffffffff01100000000f000000000000000113000000ffffffffffffffff0116000000ffffffffffffffff0119000000f0ffffffffffffff011c0000000f00000000000000011f000000ffffffffffffffff0122000000ffffffffffffffff0125000000f0ffffffffffffff01280000000f00000000000000012b000000ffffffffffffffff012e000000ffffffffffffffff0131000000f0ffffffffffffff01340000000f000000000000000137000000ffffffffffffffff013a000000ffffffffffffffff013d0000000f0000000000000006010000000400000006040000000700000006070000000a000000060a0000000d000000060d0000001000000006100000001300000006130000001600000006160000001900000006190000001c000000061c0000001f000000061f0000002200000006220000002500000006250000002800000006280000002b000000062b0000002e000000062e0000003100000006310000003400000006340000003700000006370000003a000000063a0000003d00000028",
		data: "0000000000000000ffffffffffffffff000000000000000000000000000000000e0000000000000000000000000000000000000000000000feffffffffffffff00000000000000000000000000000000efffffffffffffff00000000000000000000000000000000ffffffffffffffff000000000000000000000000000000000e0000000000000000000000000000000000000000000000feffffffffffffff00000000000000000000000000000000efffffffffffffff00000000000000000000000000000000ffffffffffffffff000000000000000000000000000000000e0000000000000000000000000000000000000000000000feffffffffffffff00000000000000000000000000000000efffffffffffffff00000000000000000000000000000000ffffffffffffffff000000000000000000000000000000000e0000000000000000000000000000000000000000000000feffffffffffffff00000000000000000000000000000000efffffffffffffff00000000000000000000000000000000ffffffffffffffff000000000000000000000000000000000e0000000000000000000000000000000000000000000000feffffffffffffff000000000000000000000000000000000e00000000000000000000000000000000000000000000000f0000000000000000000000000000000000000000000000",
	},
	atTest{
		code: "010100000001030507090b0d0f01040000000020406080a0c0e0010700000001030507090b0d0f010a0000000020406080a0c0e0010d00000001030507090b0d0f01100000000020406080a0c0e0011300000001030507090b0d0f01160000000020406080a0c0e0011900000001030507090b0d0f011c0000000020406080a0c0e0011f00000001030507090b0d0f01220000000020406080a0c0e0012500000001030507090b0d0f01280000000020406080a0c0e0012b00000001030507090b0d0f012e0000000020406080a0c0e0013100000001030507090b0d0f01340000000020406080a0c0e0013700000001030507090b0d0f013a0000000020406080a0c0e0013d00000001030507090b0d0f06010000000400000006040000000700000006070000000a000000060a0000000d000000060d0000001000000006100000001300000006130000001600000006160000001900000006190000001c000000061c0000001f000000061f0000002200000006220000002500000006250000002800000006280000002b000000062b0000002e000000062e0000003100000006310000003400000006340000003700000006370000003a000000063a0000003d00000028",
		data: "00000000000000000123456789abcdef000000000000000000000000000000000123456789abcdef000000000000000000000000000000000123456789abcdef000000000000000000000000000000000123456789abcdef000000000000000000000000000000000123456789abcdef000000000000000000000000000000000123456789abcdef000000000000000000000000000000000123456789abcdef000000000000000000000000000000000123456789abcdef000000000000000000000000000000000123456789abcdef000000000000000000000000000000000123456789abcdef000000000000000000000000000000000123456789abcdef000000000000000000000000000000000123456789abcdef000000000000000000000000000000000123456789abcdef000000000000000000000000000000000123456789abcdef000000000000000000000000000000000123456789abcdef000000000000000000000000000000000123456789abcdef000000000000000000000000000000000123456789abcdef000000000000000000000000000000000123456789abcdef000000000000000000000000000000000123456789abcdef000000000000000000000000000000000123456789abcdef0000000000000000000000000000000001030507090b0d0f00000000000000000000000000000000",
	},
	atTest{
		code: "01000000005555555555555555010100000022222222222222220102000000999999999999999901100000006666666666666666011100000011111111111111110112000000999999999999999901200000001111111111111111012100000022222222222222220122000000999999999999999901300000004444444444444444013100000011111111111111110132000000999999999999999906000000000100000006000000000100000006100000001100000006100000001100000006100000001100000006200000002100000006200000002100000006200000002100000006200000002100000006300000003100000006300000003100000006300000003100000006300000003100000006300000003100000028",
		data: "9999999999999999222222222222222299999999999999990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000999999999999999911111111111111119999999999999999000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000099999999999999992222222222222222999999999999999900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000009999999999999999111111111111111199999999999999990000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
	},
	atTest{
		code: "013e000000ffffffffffffffff013f000000ffffffffffffffff063e0000003f000000063f0000004000000028",
		data: "00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000feffffffffffffffffffffffffffffff",
		err:  ErrOverflow,
	},
	atTest{
		code: "06ffffffffffffffff28",
		err:  ErrOverflow,
	},
}

func TestAts(t *testing.T) {
	for _, atTest := range atTests {
		code, _ := hex.DecodeString(atTest.code)
		s := newStateMachine(code)

		if assert.Equal(t, atTest.err, s.execute()) {
			if atTest.data != "" {
				assert.Equal(t, atTest.data, hex.EncodeToString(s.data))
			}
		}
	}
}
